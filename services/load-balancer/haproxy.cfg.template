# HAProxy Configuration Template
# Generated by LB Controller - DO NOT EDIT MANUALLY

global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Stats endpoint for observability
frontend stats
    bind *:8404
    mode http
    http-request use-service prometheus-exporter if { path /metrics }
    stats enable
    stats uri /stats
    stats refresh 10s

# Health check endpoint
frontend health
    bind *:8405
    mode http
    http-request return status 200 content-type text/plain string "OK"

{% for frontend in frontends %}
# Frontend: {{ frontend.name | sanitize_id }}
frontend {{ frontend.name | sanitize_id }}
    bind *:{{ frontend.port | validate_num }}
    mode {{ frontend.mode | sanitize_id }}
    {% if frontend.mode == 'http' %}
    option httplog
    {% endif %}
    default_backend {{ frontend.backend | sanitize_id }}

{% endfor %}

{% for backend in backends %}
# Backend: {{ backend.name | sanitize_id }}
backend {{ backend.name | sanitize_id }}
    mode {{ backend.mode | sanitize_id }}
    balance {{ backend.balance | sanitize_id }}
    option httpchk GET /
    {% for server in backend.servers %}
    server {{ server.name | sanitize_id }} {{ server.address | sanitize_addr }}:{{ server.port | validate_num }} check weight {{ server.weight | validate_num }}
    {% endfor %}

{% endfor %}
