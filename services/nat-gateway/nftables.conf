#!/usr/sbin/nft -f

# NAT Gateway nftables configuration
# Implements SNAT for VPC traffic going to external networks

table ip nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
        
        # DNAT for Elastic IPs (simulated)
        # Map external IP to internal server
        # ip daddr 203.0.113.10 dnat to 10.1.1.10
    }

    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;
        
        # vpc-100 SNAT (10.1.0.0/16 -> external)
        ip saddr 10.1.0.0/16 oifname "eth1" masquerade comment "vpc-100 SNAT"
        
        # vpc-200 SNAT (10.2.0.0/16 -> external)
        ip saddr 10.2.0.0/16 oifname "eth1" masquerade comment "vpc-200 SNAT"
    }
}

table ip filter {
    chain forward {
        type filter hook forward priority filter; policy accept;
        
        # Allow established/related connections
        ct state established,related accept
        
        # Allow traffic from VPCs to external
        ip saddr 10.1.0.0/16 accept
        ip saddr 10.2.0.0/16 accept
        
        # Allow return traffic
        ip daddr 10.1.0.0/16 accept
        ip daddr 10.2.0.0/16 accept
    }
}

# Connection tracking for NAT translation logging
table ip raw {
    chain prerouting {
        type filter hook prerouting priority raw; policy accept;
    }
}
