vername: Deploy to Vercel (Controlled)
on:
  push:
    branches: [main]
    paths: 
      - 'control-plane/**'
      - 'docs/index.html'
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  check-deployment-needed:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decision.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v3
        - name: Check if deployment needed
          id: decision
          run: |
            # Only deploy if vercel.json changed or it's been >4 hours
            if git diff --name-only HEAD~1 | grep -q "vercel.json\|docs/index.html"; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            elif [[ $(git log --oneline -1) == *"vercel deploy"* ]]; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi

  deploy-to-vercel:
    needs: check-deployment-needed
    if: needs.check-deployment-needed.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Vercel
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
